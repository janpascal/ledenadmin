@(id: Long, myForm: Form[Lid])

@import helper._

@persoonField(field: Field, className: String = "persoon") = {
    @helper.input(field, '_label -> "Naam", '_class -> className) { (id, name, value, _) =>
        <input type="text" name="@name" value="@value"> 
        <a class="removePersoon btn danger">Verwijder</a>
    }
}

@bankrekeningField(field: Field, className: String = "bankrekening") = {
    @helper.input(field, '_label -> "Bankrekening", '_class -> className) { (id, name, value, _) =>
        <input type="text" name="@name" value="@value"> 
        <a class="removeRekening btn danger">Verwijder</a>
    }
}

@main("Bewerk lid") {
    <h1>Bewerk lid</h1>
    @helper.form(action = routes.Leden.saveLid(id), 'id -> "form") {
    <fieldset class="fieldset">
        <legend>Lid @id</legend>

        @helper.repeat(myForm("personen"), min = 1) { persoon =>
                @persoonField(persoon("name"))
        }
                
        @* hidden template *@
        @persoonField(
            myForm("personen[x].name"),
            className = "persoon_template"
        )
        
        <div class="clearfix">
            <div class="input">
                <a class="addPersoon btn success">Naam toevoegen</a>
            </div>
        </div>
    
        @helper.inputText(myForm("address"), '_label -> "Adres") 

        @helper.inputDate(myForm("lidSinds"), '_label -> "Lid sinds")

        @helper.repeat(myForm("bankrekeningen"), min = 1) { bankrekening =>
                @bankrekeningField(bankrekening("nummer"))
        }
                
        @* hidden template *@
        @bankrekeningField(
            myForm("bankrekeningen[x].nummer"),
            className = "bankrekening_template"
        )
        
        <div class="clearfix">
            <div class="input">
                <a class="addRekening btn success">Bankrekening toevoegen</a>
            </div>
        </div>
    </fieldset>

    <div class="actions">
        <input type="submit" value="Opslaan" class="btn primary"> of 
        <a href="@routes.Leden.lijst()" class="btn">Annuleren</a> 
    </div>

   <script type="text/javascript" charset="utf-8">
        $(function() {
          $( "#lidSinds" ).datepicker({ dateFormat: "dd/mm/yy", changeYear: true });
        });

        $(document).on('click','.removePersoon', function(e) {
            $(this).parents('.persoon').remove()
            renumber()
        });

        $(document).on('click','.removeRekening', function(e) {
            $(this).parents('.bankrekening').remove()
            renumber()
        });

        $(document).on('click', '.addPersoon', function(e) {
            var template = $('.persoon_template')
            template.before('<div class="clearfix persoon">' + template.html() + '</div>')
            renumber()
        });

        $(document).on('click', '.addRekening', function(e) {
            var template = $('.bankrekening_template')
            template.before('<div class="clearfix bankrekening">' + template.html() + '</div>')
            renumber()
        });

        $('#form').submit(function() {
            $('.persoon_template').remove()
            $('.bankrekening_template').remove()
        });


        // Rename fields to have a coherent payload like:
        //
        // informations[0].label
        // informations[0].email
        // informations[0].phones[0]
        // informations[0].phones[1]
        // ...
        //
        // This is probably not the easiest way to do it. A jQuery plugin would help.
        
        var renumber = function() {
            $('.persoon input').each(function(i) {
                $(this).attr('name', $(this).attr('name').replace(/personen\[.+\]/g, 'personen[' + i + ']'))
            })
            $('.bankrekening input').each(function(i) {
                $(this).attr('name', $(this).attr('name').replace(/bankrekeningen\[.+\]/g, 'bankrekeningen[' + i + ']'))
            })
        }

    </script>

    }
}
